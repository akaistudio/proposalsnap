<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>ProposalSnap ‚Äî Sign In</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{--bg:#0B0F1A;--surface:#141926;--border:#2A3148;--text:#E8ECF4;--text2:#8B95B0;--accent:#6C5CE7;--accent2:#A78BFA;--green:#4ADE80;--red:#F87171}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center}
.container{width:100%;max-width:440px;padding:24px}
.logo{text-align:center;margin-bottom:32px}
.logo .icon{width:56px;height:56px;border-radius:14px;display:inline-flex;align-items:center;justify-content:center;font-size:24px;font-weight:800;color:#fff;background:linear-gradient(135deg,#f59e0b,#ea580c);margin-bottom:12px}
.logo h1{font-size:28px;font-weight:800;color:#fff}.logo h1 span{color:var(--accent)}
.logo p{font-size:14px;color:var(--text2);margin-top:6px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px}
.card h2{font-size:20px;font-weight:700;margin-bottom:6px;color:#fff}
.card .sub{font-size:13px;color:var(--text2);margin-bottom:20px}
.fg{margin-bottom:16px}
.fg label{display:block;font-size:12px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.fg input,.fg select{width:100%;padding:12px 14px;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:#fff;font-size:14px;font-family:'DM Sans',sans-serif}
.fg input:focus,.fg select:focus{outline:none;border-color:var(--accent)}
.otp-row{display:flex;gap:8px;justify-content:center;margin-bottom:16px}
.otp-row input{width:48px;height:56px;text-align:center;font-size:24px;font-weight:800;background:var(--bg);border:1.5px solid var(--border);border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;outline:none;transition:.2s}
.otp-row input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.15)}
.btn{width:100%;padding:14px;border:none;border-radius:10px;font-weight:700;font-size:15px;cursor:pointer;font-family:'DM Sans',sans-serif;background:linear-gradient(135deg,#f59e0b,#ea580c);color:#fff;transition:.2s}
.btn:hover{opacity:.9;transform:translateY(-1px)}
.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
.switch{text-align:center;margin-top:16px;font-size:14px;color:var(--text2)}.switch a{color:var(--accent);text-decoration:none;font-weight:600;cursor:pointer}
.flash{padding:12px;border-radius:10px;font-size:13px;margin-bottom:16px}
.flash.error{background:rgba(248,113,113,.1);color:var(--red);border:1px solid rgba(248,113,113,.2)}
.flash.success{background:rgba(74,222,128,.1);color:var(--green);border:1px solid rgba(74,222,128,.2)}
.suite{margin-top:24px;text-align:center;font-size:12px;color:var(--text2)}.suite a{color:var(--text2);text-decoration:none;font-weight:600}.suite a:hover{color:var(--accent)}
.hidden{display:none}
.timer{text-align:center;font-size:13px;color:var(--text2);margin-top:10px}
.timer a{color:var(--accent);cursor:pointer;text-decoration:none;font-weight:600}
.spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:6px}
@keyframes spin{to{transform:rotate(360deg)}}
.lock-icon{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--text2);margin-top:12px;justify-content:center}
</style>
</head>
<body>
<div class="container">
    <div class="logo"><div class="icon">P</div><h1>Proposal<span>Snap</span></h1><p>AI-powered presentations in seconds</p></div>
    <div id="alertBox"></div>

    {% if show_register is defined and show_register %}
    <!-- REGISTER Step 1: Details -->
    <div id="regStep1" class="card">
        <h2>Create Account</h2>
        <p class="sub">We'll send a 6-digit code to verify your email</p>
        <div class="fg"><label>Company Name</label><input type="text" id="regCompany" required placeholder="Your company name"></div>
        <div class="fg"><label>Email</label><input type="email" id="regEmail" required placeholder="you@company.com"></div>
        <div class="fg"><label>Password</label><input type="password" id="regPassword" required minlength="8" placeholder="Min 8 characters"></div>
        <div class="fg"><label>Currency</label><select id="regCurrency"><option value="USD">üá∫üá∏ USD</option><option value="INR">üáÆüá≥ INR</option><option value="EUR">üá™üá∫ EUR</option><option value="GBP">üá¨üáß GBP</option><option value="CAD" selected>üá®üá¶ CAD</option><option value="MYR">üá≤üáæ MYR</option></select></div>
        <button class="btn" id="regSendBtn" onclick="sendRegOTP()">Send Verification Code</button>
        <div class="switch">Already have an account? <a href="/login">Sign in</a></div>
    </div>
    <!-- REGISTER Step 2: OTP -->
    <div id="regStep2" class="card hidden">
        <h2>Verify Email</h2>
        <p class="sub">Enter the 6-digit code sent to <strong id="regEmailDisplay"></strong></p>
        <div class="otp-row" id="regOtpRow"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"></div>
        <button class="btn" id="regVerifyBtn" onclick="verifyRegOTP()">Create Account</button>
        <div class="timer" id="regTimer">Resend code in <span id="regCountdown">60</span>s</div>
        <div class="timer hidden" id="regResend"><a onclick="sendRegOTP()">Resend code</a> ¬∑ <a onclick="showStep('regStep1')">Change email</a></div>
    </div>
    {% else %}
    <!-- LOGIN Step 1: Email -->
    <div id="loginStep1" class="card">
        <h2>Sign In</h2>
        <p class="sub">Enter your email to receive a 6-digit login code</p>
        <div class="fg"><label>Email</label><input type="email" id="loginEmail" required placeholder="you@company.com" onkeydown="if(event.key==='Enter')sendLoginOTP()"></div>
        <button class="btn" id="loginSendBtn" onclick="sendLoginOTP()">Send Login Code</button>
        <div class="switch">New here? <a href="/register">Create account</a></div>
    </div>
    <!-- LOGIN Step 2: OTP -->
    <div id="loginStep2" class="card hidden">
        <h2>Enter Code</h2>
        <p class="sub">Enter the 6-digit code sent to <strong id="loginEmailDisplay"></strong></p>
        <div class="otp-row" id="loginOtpRow"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"><input type="text" maxlength="1" class="otp-digit" inputmode="numeric"></div>
        <button class="btn" id="loginVerifyBtn" onclick="verifyLoginOTP()">Sign In</button>
        <div class="timer" id="loginTimer">Resend code in <span id="loginCountdown">60</span>s</div>
        <div class="timer hidden" id="loginResend"><a onclick="sendLoginOTP()">Resend code</a> ¬∑ <a onclick="showStep('loginStep1')">Change email</a></div>
    </div>
    {% endif %}

    <div class="suite"><a href="/welcome">‚Üê Back to ProposalSnap home</a></div>
    <div class="lock-icon">üîí Secured with email OTP verification</div>
</div>
<script>
document.querySelectorAll('.otp-row').forEach(row=>{
  const inputs=row.querySelectorAll('.otp-digit');
  inputs.forEach((inp,i)=>{
    inp.addEventListener('input',e=>{const v=e.target.value.replace(/\D/g,'');e.target.value=v.charAt(0)||'';if(v&&i<5)inputs[i+1].focus();});
    inp.addEventListener('keydown',e=>{if(e.key==='Backspace'&&!e.target.value&&i>0){inputs[i-1].focus();inputs[i-1].value='';}});
    inp.addEventListener('paste',e=>{e.preventDefault();const p=(e.clipboardData.getData('text')||'').replace(/\D/g,'').slice(0,6);p.split('').forEach((c,j)=>{if(inputs[j])inputs[j].value=c;});if(p.length>=6)inputs[5].focus();});
  });
});
function getOTP(rowId){return Array.from(document.getElementById(rowId).querySelectorAll('.otp-digit')).map(i=>i.value).join('');}
function clearOTP(rowId){document.getElementById(rowId).querySelectorAll('.otp-digit').forEach(i=>i.value='');}
function showAlert(msg,type){document.getElementById('alertBox').innerHTML='<div class="flash '+type+'">'+msg+'</div>';}
function showStep(id){document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
function startTimer(cntId,timerId,resendId,sec){
  let r=sec;const el=document.getElementById(cntId);
  document.getElementById(timerId).classList.remove('hidden');document.getElementById(resendId).classList.add('hidden');el.textContent=r;
  const iv=setInterval(()=>{r--;el.textContent=r;if(r<=0){clearInterval(iv);document.getElementById(timerId).classList.add('hidden');document.getElementById(resendId).classList.remove('hidden');}},1000);
}
let loginEmailVal='';
async function sendLoginOTP(){
  const email=document.getElementById('loginEmail').value.trim().toLowerCase();
  if(!email){showAlert('Please enter your email','error');return;}
  loginEmailVal=email;const btn=document.getElementById('loginSendBtn');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>Sending...';
  try{const r=await fetch('/api/auth/send-otp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,purpose:'login'})});
    const d=await r.json();if(d.success){document.getElementById('loginEmailDisplay').textContent=email;showStep('loginStep2');if(d.fallback_code){showAlert('Email unavailable. Your code: '+d.fallback_code,'success');}else{showAlert('Code sent to '+email,'success');};startTimer('loginCountdown','loginTimer','loginResend',60);setTimeout(()=>document.querySelector('#loginStep2 .otp-digit').focus(),100);}
    else{showAlert(d.error||'Failed to send code','error');}
  }catch(e){showAlert('Connection error','error');}btn.disabled=false;btn.innerHTML='Send Login Code';
}
async function verifyLoginOTP(){
  const code=getOTP('loginOtpRow');if(code.length!==6){showAlert('Enter the full 6-digit code','error');return;}
  const btn=document.getElementById('loginVerifyBtn');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>Verifying...';
  try{const r=await fetch('/api/auth/verify-otp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email:loginEmailVal,code,purpose:'login'})});
    const d=await r.json();if(d.success){window.location.href=d.redirect||'/';}else{showAlert(d.error||'Invalid code','error');clearOTP('loginOtpRow');}
  }catch(e){showAlert('Connection error','error');}btn.disabled=false;btn.innerHTML='Sign In';
}
let regData={};
async function sendRegOTP(){
  const email=document.getElementById('regEmail').value.trim().toLowerCase(),pw=document.getElementById('regPassword').value,co=document.getElementById('regCompany').value.trim(),cur=document.getElementById('regCurrency').value;
  if(!co){showAlert('Enter company name','error');return;}if(!email){showAlert('Enter email','error');return;}if(pw.length<8){showAlert('Password must be at least 8 characters','error');return;}
  regData={email,password:pw,company_name:co,currency:cur};const btn=document.getElementById('regSendBtn');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>Sending...';
  try{const r=await fetch('/api/auth/send-otp',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({email,purpose:'register'})});
    const d=await r.json();if(d.success){document.getElementById('regEmailDisplay').textContent=email;showStep('regStep2');if(d.fallback_code){showAlert('Email unavailable. Your code: '+d.fallback_code,'success');}else{showAlert('Code sent to '+email,'success');};startTimer('regCountdown','regTimer','regResend',60);setTimeout(()=>document.querySelector('#regStep2 .otp-digit').focus(),100);}
    else{showAlert(d.error||'Failed','error');}
  }catch(e){showAlert('Connection error','error');}btn.disabled=false;btn.innerHTML='Send Verification Code';
}
async function verifyRegOTP(){
  const code=getOTP('regOtpRow');if(code.length!==6){showAlert('Enter the full 6-digit code','error');return;}
  const btn=document.getElementById('regVerifyBtn');btn.disabled=true;btn.innerHTML='<span class="spinner"></span>Creating...';
  try{const r=await fetch('/api/auth/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({...regData,code})});
    const d=await r.json();if(d.success){window.location.href=d.redirect||'/';}else{showAlert(d.error||'Failed','error');clearOTP('regOtpRow');}
  }catch(e){showAlert('Connection error','error');}btn.disabled=false;btn.innerHTML='Create Account';
}
</script>
</body></html>
